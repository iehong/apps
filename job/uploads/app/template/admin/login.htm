<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
	<link href="../app/template/admin/js/element.css?v={yun:}$config.cachecode{/yun}" rel="stylesheet"
		type="text/css" />
	<link href="../app/template/admin/images/admin.css?v={yun:}$config.cachecode{/yun}" rel="stylesheet"
		type="text/css" />
	<title>{yun:}$config.sy_webname{/yun} - 后台管理中心</title>
</head>

<body>
	<div id="bind-captcha" data-id='submit_bt' data-type='click'></div>
	<div class="adminDomeAll">
		<div class="logoinLogo"><img
				src="../app/template/admin/images/admin_new_logo.png?v={yun:}$config.cachecode{/yun}"></div>
		<div class="logoinBlock1"><img src="../app/template/admin/images/lo_fk2.png"></div>
		<div class="logoinBlock2"><img src="../app/template/admin/images/lo_fk.png"></div>
		<div class="logoinBlock3"><img src="../app/template/admin/images/lo_fk3.png"></div>
		<!-- loao -->
		<div class="loginCont">
			<div class="logoinContImg">
				<div class="logoinBacimg1"><img src="../app/template/admin/images/lo_phpyun.png"></div>
				<div class="logoinBacimg2"><img src="../app/template/admin/images/lo_dp.png"></div>
				<div class="logoinBacimg3"><img src="../app/template/admin/images/lo_zzj.png"></div>
				<div class="logoinBacimg4"><img src="../app/template/admin/images/lo_sj.png"></div>
				<div class="logoinBacimg5"><img src="../app/template/admin/images/lo_ht.png"></div>
				<div class="logoinBacimg6"><img src="../app/template/admin/images/lo_sjdp.png"></div>
				<div class="logoinBacimg7"><img src="../app/template/admin/images/lo_znj.png"></div>
				<div class="logoinBacimg8"><img src="../app/template/admin/images/lo_app.png"></div>
				<div class="logoinBacimg9"><img src="../app/template/admin/images/lo_sj2.png"></div>
				<!-- +++++++++++++++++++++++++++++++++++++++++++ -->
				<div class="logoinBacimg10"><img src="../app/template/admin/images/lo_cxbg.png"></div>
				<div class="logoinBacimg100"><img src="../app/template/admin/images/lo_wx.png"></div>
				<div class="logoinBacimg11"><img src="../app/template/admin/images/lo_cxbg.png"></div>
				<div class="logoinBacimg110"><img src="../app/template/admin/images/lo_xcx.png"></div>
				<div class="logoinBacimg12"><img src="../app/template/admin/images/lo_cxbg.png"></div>
				<div class="logoinBacimg120"><img src="../app/template/admin/images/lo_dy.png"></div>
				<div class="logoinBacimg13"><img src="../app/template/admin/images/lo_cxbg.png"></div>
				<div class="logoinBacimg130"><img src="../app/template/admin/images/lo_bd.png"></div>
				<!-- +++++++++++++++++++++++++++++++++++++++++++ -->
				<div class="logoinBacimg14"><img src="../app/template/admin/images/lo_sm.png"></div>
				<div class="logoinBacimg15"><img src="../app/template/admin/images/lo_sm.png"></div>
				<!-- +++++++++++++++++++++++++++++++++++++++++++ -->
				<div class="logoinBacimg16"><img src="../app/template/admin/images/lo_sm.png"></div>
				<div class="logoinBacimg17"><img src="../app/template/admin/images/lo_sm.png"></div>
				<!-- +++++++++++++++++++++++++++++++++++++++++++ -->
				<div class="logoinBacimg18"><img src="../app/template/admin/images/lo_sm.png"></div>
				<div class="logoinBacimg19"><img src="../app/template/admin/images/lo_sm.png"></div>
			</div>
			<div class="loginBoxs">
				<div class="logoinRight">

					<div class="logoinName">
						<span>欢迎登录后台管理系统</span>
					</div>
					<div class="loginIptbox" id="loginapp">
						<template v-if="islook">
							<div class="loginTabse" v-if="showDiv1">
								<ul class="logoinList">
									<li>
										<div class="adminLogins"><input type="text" class="ipt" placeholder="请输入用户名"
												v-model="username" />
									</li>
									<li>
										<div class="adminLogins adminLoginTwo"><input type="password" class="ipt"
												placeholder="请输入密码" v-model="password" /></div>
									</li>
									{yun:}if strpos($config.code_web,"后台登录")!==false{/yun}

									{yun:}if $config.code_kind > 2{/yun}
									<div class="gtdx-captcha">
										<input type='hidden' ref="verify_token" name="verify_token" id="verify_token" value="">
										{yun:}if $config.code_kind == 6{/yun}
										<input type='hidden' ref="verify_str" id="verify_str" name="verify_str" value="">
										{yun:}/if{/yun}
										<input type='hidden' id="popup-submit">
										<input type='hidden' id="bind-submit">
									</div>
									{yun:}else{/yun}
									<li>
										<div class="loginMessage">
											<input type="text" placeholder="输入验证码" class="ipt" style="width:125px;"
												v-model="authcode" />
											<img src="{yun:}$config.sy_weburl{/yun}/app/include/authcode.inc.php"
												align="absmiddle" id='vcode_imgs' @click="checkCode('vcode_imgs');">
										</div>
									</li> {yun:}/if{/yun}

									{yun:}/if{/yun}
									<li>
										<div class="adminLoginsButton">
											<span id="submit_bt" @click="login" class="adminLogiSub" name="login_sub" value="登录">登录</span>
										</div>
									</li>
								</ul>
								<input type="hidden" name="pytoken" value="{yun:}$pytoken{/yun}">
								<div class="loginIptText" style="color: #999; font-size: 13px; text-align:center;">
									<span>官方服务电话：{yun:}$config.sy_freewebtel{/yun}</span>
								</div>
								{yun:}if $config.wx_author_htlogin !== '0'{/yun}
								<div class="weixnLogins">
									<div @click="toggleDiv">
										<img src="../app/template/admin/images/chyasw.png" alt="">
										<span>微信扫码登录</span>
									</div>
								</div>
								{yun:}/if{/yun}
							</div>

							<div class="loginTabse" v-else>
								<div class="weixinsapoyis">
									<div class="weixinsapImg">
										<img :src="code_img" alt="">
									</div>
									<div class="weixinsapTxte">
										<span>请使用微信扫一扫登录</span>
									</div>
								</div>
								<div class="loginIptText" style="color: #999; font-size: 13px; text-align:center;">
									<span>官方服务电话：{yun:}$config.sy_freewebtel{/yun}</span>
								</div>
								<div class="weixnLogins">
									<div @click="toggleDiv">
										<img src="../app/template/admin/images/zhanghao.png" alt="">
										<span>账号密码登录</span>
									</div>
								</div>
							</div>
						</template>
					</div>
				</div>
			</div>

		</div>
	</div>
	<script src="../app/template/admin/js/jquery.min.js?v={yun:}$config.cachecode{/yun}"></script>
	<script src="../app/template/admin/js/vue.min.js?v={yun:}$config.cachecode{/yun}"></script>
	<script src="../app/template/admin/js/element.js?v={yun:}$config.cachecode{/yun}"></script>
	<script src="../app/template/admin/js/axios.min.js?v={yun:}$config.cachecode{/yun}"></script>
	<script src="../app/template/admin/js/api.js?v={yun:}$config.cachecode{/yun}"></script>
	{yun:}include file="$tplstyle/verify/verify_js.htm"{/yun}
	<script>
		var weburl = "{yun:}$config.sy_weburl{/yun}",
			code_web = '{yun:}$config.code_web{/yun}',
			code_kind = '{yun:}$config.code_kind{/yun}';

		const loginapp = new Vue({
			el: '#loginapp',
			data: function () {
				return {
					username: '',
					password: '',
					verify_token: '',
					verify_str: '',
					authcode: '',
					cannext: true,
					showDiv1: true,
					code_img:'',
					codesetval:null,
					islook:false,
				}
			},
			created() {
				this.$nextTick(function () {
					this.islook = true;
				})
			},
			methods: {
				toggleDiv() {
					if(this.showDiv1){
						this.getcode();
					}else{
						this.showDiv1 = true;
					}
				},
				async wxbindstatus() {
				    var that = this;
				    
					axios.post('index.php?c=getwxloginstatus',{}).then(function (result) {
						var res = result.data;
						if (res.error == 0) {
							clearInterval(that.codesetval);
						    message.success(res.msg, function () {
						        // 清空localStorage
								localStorage.clear();
								
								// window.location.reload();
								window.location.href = location.origin + location.pathname;
								localStorage.setItem('indexPath', res.data.path); // 解决默认进首页还是进工作台
						    });
						}else if(res.msg!=''){
							message.error(res.msg);
						}
					}).catch(function (error) {
						console.log(error);
					})
				},
				// 获取微信绑定二维码
				async getcode() {
				    var that = this;
				    
					axios.post('index.php?c=wxlogin',{}).then(function (result) {
						var res = result.data;
						if (res.error == 0) {
						    that.code_img = res.data.code_url;
						    that.codesetval = setInterval(function () {
						        that.wxbindstatus()
						    }, 2000);
							
							that.showDiv1 = false;
						} else {
						    message.error(res.msg);
						}
					}).catch(function (error) {
						console.log(error);
					})
				},
				login: function () {
					if (!this.cannext) {
						return false;
					}
					if (this.username == '') {
						this.$message.error('请填写用户名');
						return false;
					}
					if (this.password == '') {
						this.$message.error('请填写密码');
						return false;
					}
					var codesear = new RegExp('后台登录');
					if (codesear.test(code_web)) {
						if (code_kind == 1) {
							if (this.authcode == '') {
								this.$message.error('请填写验证码');
								return false;
							}
						} else if (code_kind > 2) {
							if (this.$refs.verify_token.value == '') {
								if (code_kind == 6) {
									$("#bind-captcha").trigger("click");
								} else {
									$("#bind-submit").trigger("click");
								}
								return false;
							}
						}
					}

					var _this = this;
					var param = {
						username: this.username,
						password: this.password,
						authcode: this.authcode,
					};
					if (this.$refs.verify_token) {
                        param.verify_token = this.$refs.verify_token.value
					}
                    if (this.$refs.verify_str) {
                        param.verify_str = this.$refs.verify_str.value
                    }
					this.cannext = false;

					axios.post('index.php?c=login', param).then(function (response) {
						var res = response.data;
						if (res.error == 0) {
							// 清空localStorage
							localStorage.clear();

							// window.location.reload();
							window.location.href = location.origin + location.pathname;
							localStorage.setItem('indexPath', res.data.path); // 解决默认进首页还是进工作台
						} else {
							_this.cannext = true;
							_this.$message.error(res.msg);
							_this.checkCode('vcode_imgs');
						}
					}).catch(function (error) {
						console.log(error);
					})
				},
				keyDown: function (e) {
					if (e.keyCode === 13) {
						this.login()
					}
				},
				checkCode: function (id) {
					if (document.getElementById(id)) {
						document.getElementById(id).src = weburl + "/app/include/authcode.inc.php?" + Math.random();
					}
				}
			},
			mounted() {
				// 绑定监听事件
				window.addEventListener("keydown", this.keyDown);
			},
			destroyed() {
				// 销毁事件
				window.removeEventListener("keydown", this.keyDown, false);
			}
		});
	</script>
</body>

</html>